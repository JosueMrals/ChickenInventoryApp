rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================
    //  üîê REGLA GLOBAL ‚Äì Exigir autenticaci√≥n
    // =====================================================
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // =====================================================
    //  üë§ USERS ‚Äî roles, perfiles
    // =====================================================
    match /users/{userId} {
      allow read: if request.auth != null;

      // Cualquier usuario autenticado puede crear su perfil
      allow create: if request.auth != null;

      // Solo admin puede editar/eliminar perfiles
      allow update, delete: if isAdmin();
    }

    // =====================================================
    //  üë• CUSTOMERS ‚Äî con tipo, descuento, cr√©dito
    // =====================================================
    match /customers/{customerId} {
      allow read: if request.auth != null;

      // Crear / actualizar clientes:
      // admin o user
      allow create, update: if isAdmin() || isUser();

      // Pero solo ADMIN puede modificar campos sensibles:
      allow update: if isAdmin() ||
        (
          isUser() &&
          !(
            // campos restringidos a admin
            'creditLimit' in request.resource.data.diff() ||
            'discount'    in request.resource.data.diff() ||
            'type'        in request.resource.data.diff()
          )
        );

      // Solo admin puede eliminar
      allow delete: if isAdmin();
    }

    // =====================================================
    //  üì¶ PRODUCTS ‚Äî precio, stock, mayoreo
    // =====================================================
    match /products/{productId} {
      allow read: if request.auth != null;

      // Crear y eliminar SOLO admin
      allow create, delete: if isAdmin();

      // update:
      allow update: if isAdmin() ||
        (
          isUser() &&
          // Solo se permite actualizar stock y lastSaleUpdate
          (
            request.resource.data.keys().hasOnly(['stock', 'lastSaleUpdate']) &&
            request.resource.data.stock is number
          )
        );
    }

    // =====================================================
    //  üßæ SALES ‚Äî multi-producto, carrito
    // =====================================================
    match /sales/{saleId} {
      allow read: if request.auth != null;

      // Crear: admin o user
      allow create: if isAdmin() || isUser();

      // Ventas NO pueden editarse ni borrarse
      allow update, delete: if false;
    }

    // =====================================================
    //  üí∞ CREDITS ‚Äî historial de cr√©ditos, abonos
    // =====================================================
    match /credits/{creditId} {
      allow read: if request.auth != null;

      // Crear cr√©ditos desde venta
      allow create: if isAdmin() || isUser();

      // Actualizar cr√©ditos (abonos) permitido a admin y user
      allow update: if isAdmin() || isUser();

      // Solo admin puede eliminar cr√©ditos
      allow delete: if isAdmin();
    }

    // =====================================================
    //  üî¢ COUNTERS ‚Äî control de correlativos
    // =====================================================
    match /counters/{docId} {
      allow read: if request.auth != null;

      // Crear o incrementar contadores: admin/user
      allow update, create: if isAdmin() || isUser();
    }

    // =====================================================
    // ‚öô FUNCIONES COMUNES
    // =====================================================
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    function isUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "user";
    }
  }
}